#!/usr/bin/env bash
#
# opencode-shared - Start or attach to a shared OpenCode server
#
# Usage:
#   ./opencode-shared [options]
#
# Options are passed through to 'opencode attach' (e.g., --session <id>)
#
# Environment variables:
#   OPENCODE_SERVER_PORT     - Port for the shared server (default: 4096)
#   OPENCODE_SERVER_PASSWORD - Password for server authentication (optional)
#   OPENCODE_SERVER_LOG      - Log file path (default: /tmp/opencode-server.log)
#

set -e

PORT="${OPENCODE_SERVER_PORT:-4096}"
LOG_FILE="${OPENCODE_SERVER_LOG:-/tmp/opencode-server.log}"
SERVER_URL="http://localhost:${PORT}"
PIDFILE="/tmp/opencode-server.pid"

# Check if server is already running
is_server_running() {
    if [ -f "$PIDFILE" ]; then
        local pid
        pid=$(cat "$PIDFILE")
        if kill -0 "$pid" 2>/dev/null; then
            # Process exists, verify it's actually listening on the port
            if curl -s --connect-timeout 1 "${SERVER_URL}/health" >/dev/null 2>&1 || \
               curl -s --connect-timeout 1 "${SERVER_URL}" >/dev/null 2>&1 || \
               nc -z localhost "$PORT" 2>/dev/null; then
                return 0
            fi
        fi
        # Stale PID file, remove it
        rm -f "$PIDFILE"
    fi
    
    # No PID file, but check if something is listening on the port anyway
    if nc -z localhost "$PORT" 2>/dev/null; then
        return 0
    fi
    
    return 1
}

# Start the server in the background
start_server() {
    echo "Starting OpenCode shared server on port ${PORT}..."
    
    # Start server in background
    nohup opencode serve --port "$PORT" >> "$LOG_FILE" 2>&1 &
    local server_pid=$!
    echo "$server_pid" > "$PIDFILE"
    
    # Wait for server to be ready
    local max_attempts=30
    local attempt=0
    
    while [ $attempt -lt $max_attempts ]; do
        if nc -z localhost "$PORT" 2>/dev/null; then
            echo "Server started (PID: ${server_pid})"
            echo "Server logs: ${LOG_FILE}"
            return 0
        fi
        
        # Check if process is still running
        if ! kill -0 "$server_pid" 2>/dev/null; then
            echo "Error: Server process died. Check logs: ${LOG_FILE}"
            rm -f "$PIDFILE"
            exit 1
        fi
        
        sleep 0.5
        attempt=$((attempt + 1))
    done
    
    echo "Error: Server failed to start within 15 seconds. Check logs: ${LOG_FILE}"
    exit 1
}

# Main logic
main() {
    if is_server_running; then
        echo "Connecting to existing OpenCode server at ${SERVER_URL}"
    else
        start_server
    fi
    
    # Attach to the server, passing through any additional arguments
    exec opencode attach "$SERVER_URL" "$@"
}

main "$@"
