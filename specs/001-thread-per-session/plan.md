# Implementation Plan: Thread-Per-Session Multi-Session Management

**Branch**: `001-thread-per-session` | **Date**: 2026-01-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-thread-per-session/spec.md`

## Summary

Transform the OpenCode Mattermost plugin from manual single-session connection to **automatic thread-per-session architecture**. Each OpenCode session automatically gets its own Mattermost thread on startup. Users control multiple sessions in parallel via separate threads. Thread-session mappings persist across restarts for crash recovery.

## Technical Context

**Language/Version**: TypeScript 5.7+ with Bun runtime  
**Primary Dependencies**: @opencode-ai/plugin ^1.1.17, axios ^1.7.9, ws ^8.18.0, zod ^3.24.1  
**Storage**: File-based JSON persistence for thread-session mappings (~/.config/opencode/mattermost-threads.json)  
**Testing**: bun test  
**Target Platform**: Node.js 18+ / Bun (OpenCode plugin environment)  
**Project Type**: Single project (OpenCode plugin - NOT a TUI)  
**Performance Goals**: Thread creation < 500ms, message routing < 100ms  
**Constraints**: Must work within OpenCode plugin lifecycle, must not block session startup  
**Scale/Scope**: Support 10+ concurrent sessions per user

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| Is this a TUI project? | **NO** | This is a backend OpenCode plugin, NOT an Ink terminal app |
| Does it require Ink/React? | **NO** | Uses axios, ws, zod for HTTP/WebSocket communication |
| File-based persistence allowed? | **YES** | JSON file persistence is appropriate for thread mappings |
| WebSocket usage allowed? | **YES** | Already in use for Mattermost real-time events |

**Result**: All gates pass. Proceed with Phase 0.

## Project Structure

### Documentation (this feature)

```text
specs/001-thread-per-session/
├── plan.md              # This file
├── research.md          # Phase 0: API patterns, persistence strategy
├── data-model.md        # Phase 1: Entity definitions
├── quickstart.md        # Phase 1: Quick reference
├── contracts/           # Phase 1: API contracts
│   ├── thread-creation.md
│   ├── message-routing.md
│   └── persistence-format.md
└── tasks.md             # Phase 2: Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── clients/
│   ├── mattermost-client.ts      # HTTP API client (extend for threading)
│   └── websocket-client.ts       # WebSocket client (extend for thread events)
├── command-handler.ts            # Modify: reject prompts in main DM
├── config.ts                     # Configuration loading
├── file-handler.ts               # File uploads/downloads
├── logger.ts                     # File-based logging
├── message-router.ts             # NEW: Thread-aware message routing
├── models/index.ts               # Extend: ThreadSessionMapping types
├── monitor-service.ts            # Extend: Thread-aware monitoring
├── notification-service.ts       # Extend: Post to correct thread
├── opencode-session-registry.ts  # Extend: Auto-connect on session start
├── reaction-handler.ts           # Extend: Thread-aware reactions
├── response-streamer.ts          # Extend: Stream to correct thread
├── session-manager.ts            # Extend: Thread-session mappings
├── thread-manager.ts             # NEW: Thread lifecycle management
└── persistence/
    └── thread-mapping-store.ts   # NEW: Persist/load thread mappings

tests/
├── unit/
│   ├── thread-manager.test.ts
│   ├── message-router.test.ts
│   └── persistence.test.ts
└── integration/
    └── thread-lifecycle.test.ts
```

**Structure Decision**: Single project structure. New files for thread management and persistence. Extend existing services to be thread-aware.

## Key Architecture Decisions

### 1. Auto-Connect on Session Start
- Poll OpenCode session list to detect new sessions (no session.start event available)
- Create thread immediately, non-blocking
- Store mapping before returning control to session

### 2. Thread-Session Mapping Persistence
- JSON file at `~/.config/opencode/mattermost-threads.json`
- Keyed by session ID
- Contains: threadId, rootPostId, sessionName, projectDir, createdAt, status
- Load on plugin init, save on mapping change

### 3. Message Routing
- WebSocket events include `root_id` for thread messages
- Route based on `root_id` → session lookup
- Main DM (no root_id) → command-only, reject prompts

### 4. Response Streaming
- Modify ResponseStreamer to accept threadId
- All posts include `root_id` to stay in thread
- Existing streaming logic unchanged

## Complexity Tracking

No constitution violations. Architecture is straightforward extension of existing plugin.

## Next Steps

1. **Phase 0 Research** (research.md)
   - Mattermost threading API patterns
   - OpenCode plugin lifecycle hooks
   - Persistence strategy validation

2. **Phase 1 Design** (data-model.md, contracts/)
   - ThreadSessionMapping entity
   - API contracts for thread creation/routing
   - Persistence file format

3. **Phase 2 Tasks** (/speckit.tasks)
   - Implementation task breakdown
   - Dependency ordering
